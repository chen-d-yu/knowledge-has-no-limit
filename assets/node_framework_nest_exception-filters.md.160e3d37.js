import{_ as n,o as a,c as l,L as p}from"./chunks/framework.a932675b.js";const o="/knowledge-has-no-limit/assets/image-20240121121245877.728228a6.png",e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPsAAABwCAYAAADYBQa9AAAPcklEQVR4nO3dfWxUZb7A8S83kNy6BOyuM5R2qeVudReZ4hiavSIQ0WXppRBW2hS22Jg2rTdWCBGIqXNhIXplZ8lKSZAbcO2mXumLUKYigZY3FQJadm2X4bbVRbtpAdtOZzYiNyvcxD/O/WPmzJyZzkynLzNn4Pw+yUTP85znPI+Nv3me85zzPDNJURQFIcQ975/0boAQIjEk2IUwCAl2IQxCgl0Ig5BgF8IgJNiFMAgJdiEMQoJdCIOQYBfCICTYhTAICXYhDGKyHpWePn06Yt6yZcsS2BIhjEOXYAew/NwyLK3rz106tEQIY5BhvBAGIcEuhEHoHOwd7E3NICM1g4zUvXyhb2OEuKeFBLuHpup9ZNvepcmTgNoHrtP5H8fov9lP/82NzElAlUIYlSbYPTRVH8KWloPdlKDa0zPJSVBVQhidP9g9H7ViS3uannWPJLD6+Wx86hP2tiewSiEMyh/spqefS3Cg+6TPovPjjsTXK4TB6DZB1/F738TcVtj58ny9miGEYegW7PNf7vdOzO2Erb+Xnl2IeNP/OfvADXKekp5diHgLvC7rOU9FdSfn1OPqfdiAJb9cS83T8Zqe72DvxwvZ+HKcLi+E8AsEu+lJauxPJrb2get0kpnYOoUwKH2H8emZ5Px2lbxBJ0QC6LbqzWs+G2/2s9F3JKvehIgf/SfohBAJoVvPLr24EImlS7Cnp6djsQzfvEIIET8yjBfCICTYhTAICXYxLlMKGkaVPtK54cqNlBat/JSChmEfozJWsA84cFQ4cNHOKfMe7tUpQldzGY5mN3TsoW73RK0f7sZecJpLDNH4SjONbm/q983r/AEUGlBjCTLt9cYiXPnvm9f5P5Fc+kMD9ivgamlmTcvQmOtPZsETdN1Hya772ncwDfvm5yhK1EYW4q6lBpE2mKYUNIQNrlhHAqHl1fzQL5dw50cLaiMLfje+DprsG3gMvIF/8DxLNj+JxLvOBhw4rJXcqWqhZEvu+K93aSeTFmzj9TaFrY+P/3JakYbU0QIx0hdDpDw14NX0aOVD22FkkxRFUQDwePCYTIHA9pynovom6+3PeIN/AnV1dSXXo7eOPTiuZTL1hUr+caCLhVRx9oUTmFrd5PkW5HXtNuPc5Ts/JOiC8rBhdW/CEkMeHXuoW24Pn6cGuO9Q25aR2jMSV2MhM9c1T0iwa3vc0PRYAzj0GqGBrBppiK/Nl949DCUC94f/rfykvjtS9rh0dnbG5bpj1l6tHDRVK53KZ8rJ8lLlpGNIGXSUKkccQ4qiKMqgo1Q52R44XZuntFcrB9/4THOxz5ST6nG0vP4jypHyI8qgL6fzDVPgmsqQcqHcFKiz/4hyxFStqH+1qO3RweTV9f5/RvuEK6MtF5oe7tyJao8RhX2pxvPRuyw4M40muw7bVOkk5cCzWIBvmcf9BWbSOubBNQA3PS0n8BwzU6ctULUeMMPMTFJ25VO3C1IOdFFYkEveFt850fLSCymsCVzOssTG1WtRGrgqkweIoT06Ch1eqyINxdW8aGXDidS7R6ojUhuMZliwX27YR5Erhza73KsHrCDLWcui9DBZ6YUUugsB79C6zkxgWB0tj3ZOmfPR7tidcuBZ37+ZWVTTxcUKM3XHAvWnxdKeJBDrPbIagNHOD52Mi3TvH26Cb6R2GS74td38X+rfVMo/dMd9OJGMw3jvMHhIuVDuGy7707zDZO1wPHQYrx1SBw3PR8iLeE1FUTrfKFUu9IdvbtT2xKLtdQVQXm+LvUg0oUPyaPkjlYml/EhD84m4FQg12FCgQIFSf2Ncl9FVoGfvPkpRJ9B5iOwzgS+D8pIN2OYm/DsoqaQV1GJVe2bw9c7egy4y+cF+tQcGbS8cLY/5z5K13+K/ZsqB/Ux9wYKDLgoLzFiKV+KwBg/V1Um6aO2Jhav3L6P/I4xCLD11pF412nA+2uO1aI/utCOIsfbmvT3N8NqnrPvxmIonBz2+YZKuZ082IZN3/rSgyb7kMd4Jtlh6/nDHsfTs0SYGYzeo1BdN3EhILzpvXiHCSl/MDCycNVdqEr2jgmQV7TFbNGOZbAt3HO6ZfrRn9NHaPFwvvU2v8/ThGE9PUoHn7AmUdM/ZhTAAY70bL4SBSbALYRAS7EIYhAS7EAYhwS6EQUiwC2EQxgr2u2qnGrWNbi5WlHFxQO/2iLud7FRjOEM0vvIhz/3Lo3z/7wZ/D9pgAj27ZqeaHvsGekqmYTt4PmhVlkgmLhrWTGLSmgZcejdF3BUiv0HXfZTsKw/Ts27i17Qn5xt0wUtOAzvDuLlYYaHvGIANqzOTq9ZK7vh2lsG/Y8wKspzr+c6aj0ezBDVoR5lV+1laU+hdCKPZpSblQBc/7bXg9K97j2VRSxs7Jz3BtqJ6Bg+v0yx/jezSHxpYfDI09Z9590ABxYOnmfLq371JD2dxo/gfzHr176yu+AWHc//Gmhf6eGzHOmyPAle8576mHqujhS8JlP/dEzG1SSRQ8KvybuXw7jeVn7zyZtx2qVGUZFwIo1na6j8OXWL6mXLSVKoceSNkgYrm/CNB11DCLmM9GLKYZdBRqhwpD955Jr5cSkNVvTL5ra6wuW1v1SuTqxxKkTZ/6BOlaHW98lun79h5SpmsOW57S3u96NcX+glZCGOiaPMGisDbs1d7aDPChpMDFxg6ZqfPbMepSTZVAiEbRMwoLozQY51gamUt2vFK1zk7piWb/Mdpj68kpeUaLnKDrnFnznoKNfvL6e7LqWz+Xaz38918fBLgClNOXtGk38IF0rsnkcir3uY+THndl3wN936wQ/AQO6J53B9xd5gV/GDm2KpOmZ05toLx8vBUskZZZHXFLzicPyMuzRETwz9Bd7lhH9kNnwdyur/kj6ZU7ua1+jFLX8wMKrnSoSZMzOMuyxIbnnOBH2lwXTrOnTkPTlBvl/gJusv94X48YS5P/Ru8X3OFS74U9QcXtFyNhUyaVEjD18MuIBIkaILOu9Hk//qOfkxTHLaRhrt5gi5AzQ/eKtpLO8kWywSdX0yjC9XoJ+hUrpZmZtX8n+8ozASd3wNcaF7G48PKeEWcoOMBXtuRge3RwK1A239O4gk+RfnNglG0VEwkWc8uEsBFw5qZ9G6e+B+lELEz1ht0Qie+nV4k0HUl21KJBFjAVkWG73qTnl0Ig5BgF8IgJNiFMAgJdiEMQoJdCIOQYBfCIIwV7HfVTjUJ0LEHR7M7xpNl55y7Xdhg93z0Ltm2fdi7E92cJOb/ohit+HyxuJrLqDObvZ8xtSu5DJ3Zzn32YnZplx06a7nPXuz7bOfQoCZv8DTF/ryQciKs4cHuOY/N+SD2HB1aI2LTsYezLStZ6nZT4nazNP84n8TcQ8fLOBbmDJ7mpa8WUTtbm9jNrtZeaksbuW1r5HbpIo6+U8ufAHBz6P1arMt9ebZt0BryZSCGCQl2D00Hb7J+85Nk69Oe+EovpLCmkDRyyXNvClp7zoADh9pTms2B4a2abq3kzrFKzqrn7A6sZuvaHSgXSG/nlNlMnTkfD3acw3rhdk5pe+TQkUOk9uBbJ18ZWDCTVlDLwgev+8sGtSeo13dzsULNCzPaCKozdKiu/s3MLKrx7sITrJfepih/+4jcHHq/n5deXBa8rNb5Z16dvZa16rLhmVaemd5L3yAw6OQoZZRa1ZPnsmT2V/SFW5Qn/IKC3fNRKz158VnpltzcXNx+nBlOb09Z4nazkHrv/+zphRS63ZQ495Oyar+/Ny3Zkgt4h9NXZ3f5yrVg2vVfviDJJU9Nw4ZVLRfTqrYo7cHNt18MXzufNj/Xv5rOSYu/3NL845z1fQG5mqvom6PmLaY/aNVdO6e2w0K1ne71fGcdze3HArYqCsooV+ANndlH3xNl/GtouqeXX/3I5BvKb+fQoJmsH/oCeqifD36YwQzfUH6XE7J+9BBOj96jm+QWCPbuo9hYjs2QG46auX/OCfqsgR4vrWBTmN5ruLSCWs2ecblkVOnbHu/uOLmB9j2+kpQvruHCTU/LCU1eLnmttkDBjgt4tCMXcz4e/odv4zkR56zlJTZQZR35VDF+voUwHppOfc05zyGyz2hyO/fxx5yn47LpZLKxbHFj2YJ/KOvUbBoZ1bB16SvIKo5ne7xfBP2DDNsya9yqWvwjlvhzc+jT03xw6zT3tWuSe4t59a/buP2z2XzwVw/8sozbVt/53zxE1gyADH71aT9DM5fRaFsGwJ/e+wrrz2LZqNO4fD27d++5Hnvg05QD5SUbDBHo4Obibt+9rW/Ybq06wXcxTPh0nbNjalWHvl1krRpFtceO06P2nIPXuRNjeyxLbHj2B+7FXc1l/nvzyLvjmMnOXxGU13VO8yU1f7HmFgRG/xRhtBN0Zta+qE6weT8fz4Ydyxu5/eu5YP05O3oPBSbdBp0cvTWbrJl479+p5R3/DHw353rVLwIRiSxxBRi4zv2zr3PWrOkZqloo0W4Cmb6YGVg4a64M5G/JxVK8n6tWM3UArCDrwDz6rGXgHxXkklGVj1PdzNK/G00uea3zqLOa6QNYtYIUMmNrz/xNLM0vC7RFu8PN/E1Yz5mpU4uu2s/SGm9vnVawi6wKiz/PVKUZxpNLnnMlDu1/izN4A83ofBN0RTEXGMFcqkoXUfxOMWUAPERt6Wu+e3sza1/cxi57Mfe1es/esbwxMJknwpKdaoQwCGO9QSeEgUmwC2EQEuxCGIQEuxAGocts/MDAAAMDw9/WyMvLA+Cbb75JdJOEuOfp9uht1k9n6VW1EIak63P26dOnh01PTU1NcEuEuPfJPbsQBqFbsDv3PkJGagYZqRnsbR/5fCHE+AQN4y837KOoU5Ngyonb77NbN35O/2+m43Y8z3txuL4QIpgm2D30uOL3y61CCH3pe88+8D7vsZONiVpVKYSBBffspIJmKF9esiGum1m421roZGH8KhBC+AX37J5Oeh71rWnfnMPf6o5yOY6VmwvfZidbfRN1e+NYkxBC07M/gs2u2ajC9Ah5plZ6PPBYPGboALfjebayk/6bbwOQkborPhUJIYL3oMu2aXpyz+ec8kwjO06BDmBekI/sWC1EYgR69rnP0FNylGzbPl/CNOybn4vvzHz6an7N8+xtf1sm6YSIs+DXZec+Q489wplCiLua7m/QPVbRolcThDAU3RbCqG/QCSESQ9dVb7du3QqbfvPmzQS3RIh7n27BfuPqDb2qFsKQdNlKWgiReLKeXQiDkGAXwiAk2IUwCAl2IQxCgl0Ig5BgF8IgJNiFMAgJdiEMQoJdCIP4fwSDm3wrcroVAAAAAElFTkSuQmCC",t="/knowledge-has-no-limit/assets/image-20240121220425386.0976f5bd.png",E=JSON.parse('{"title":"异常过滤器","description":"","frontmatter":{"outline":[1,3],"typora-copy-images-to":"./assets"},"headers":[],"relativePath":"node/framework/nest/exception-filters.md","lastUpdated":1725964165000}'),c={name:"node/framework/nest/exception-filters.md"};function r(F,s,y,D,i,B){return a(),l("div",null,s[0]||(s[0]=[p('<h1 id="异常过滤器" tabindex="-1">异常过滤器 <a class="header-anchor" href="#异常过滤器" aria-label="Permalink to &quot;异常过滤器&quot;">​</a></h1><p><code>Nest</code> 有个内置的异常处理层，异常过滤器<code>(exception filters)</code> 的定位是用于处理未手动捕获的异常。</p><p><img src="'+o+`" alt="image-20240121121245877"></p><p>在服务端处理的过程中，很多时候都需要抛出异常，而这种异常是不能乱抛的，往往需要真实准确的异常错误信息反馈给前端。</p><h2 id="内置-http-异常" tabindex="-1">内置 <code>HTTP</code> 异常 <a class="header-anchor" href="#内置-http-异常" aria-label="Permalink to &quot;内置 \`HTTP\` 异常&quot;">​</a></h2><p><code>Nest</code> 提供一组继承自基类 <code>HttpException</code> 的标准异常，代表许多最常见的 HTTP 异常。</p><ul><li><code>BadRequestException</code></li><li><code>UnauthorizedException</code></li><li><code>NotFoundException</code></li><li><code>ForbiddenException</code></li><li><code>NotAcceptableException</code></li><li><code>RequestTimeoutException</code></li><li><code>ConflictException</code></li><li><code>GoneException</code></li><li><code>HttpVersionNotSupportedException</code></li><li><code>PayloadTooLargeException</code></li><li><code>UnsupportedMediaTypeException</code></li><li><code>UnprocessableEntityException</code></li><li><code>InternalServerErrorException</code></li><li><code>NotImplementedException</code></li><li><code>ImATeapotException</code></li><li><code>MethodNotAllowedException</code></li><li><code>BadGatewayException</code></li><li><code>ServiceUnavailableException</code></li><li><code>GatewayTimeoutException</code></li><li><code>PreconditionFailedException</code></li></ul><p>内置异常还可以使用 <code>options</code> 参数提供错误信息和错误码：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">BadRequestException</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Something bad happened</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">cause</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">description</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Some error description</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>响应将如下所示：</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Something bad happened</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Some error description</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">statusCode</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">400</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="抛出异常" tabindex="-1">抛出异常 <a class="header-anchor" href="#抛出异常" aria-label="Permalink to &quot;抛出异常&quot;">​</a></h2><p>只要我们在程序中抛出错误时，就会被异常层捕获并响应给客户端：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cats</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CatsController</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">catsService</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CatsService</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">getHello</span><span style="color:#89DDFF;">():</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">HttpException</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        message</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">请求错误</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        statusCode</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#F07178;">    )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>访问 <code>/</code> ，客户端会接收到抛出的异常：</p><p><img src="`+e+`" alt="image-20240121124247607"></p><h2 id="自定义异常" tabindex="-1">自定义异常 <a class="header-anchor" href="#自定义异常" aria-label="Permalink to &quot;自定义异常&quot;">​</a></h2><p>大部分情况下，<code>Nest</code> 内置的异常类已经覆盖 <code>HTTP</code> 请求大部分的场景。如果确实需要创建自定义异常，这个异常类需要继承基类 <code>HttpException</code> 类，<code>Nest</code> 将会识别我们抛出的异常。</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">HttpException</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@nestjs/common</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">HttpExceptionOptions</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@nestjs/common/exceptions/http.exception</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ParamException</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">extends</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpException</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">response</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">|</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">status</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">options</span><span style="color:#89DDFF;">?:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpExceptionOptions</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">super</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">response</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">status</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">options</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 抛出自定义异常</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#82AAFF;">getHello</span><span style="color:#BABED8;">(): string </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ParamException</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      message</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">参数错误</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      statusCode</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">BAD_REQUEST</span></span>
<span class="line"><span style="color:#F07178;">  )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>但是在实际开发处理中，服务端一般不会抛 <code>HTTP</code> 异常给客户端。</p><p>一般的做法是遵循 <a href="./http-protocol#restful-接口规范"><code>RESTFul</code> 风格</a>，返回给前端 <code>HttpCode: 200</code>，并约定业务使用的 <code>errorcode</code> 编码，抛出通用的业务错误。前端根据约定的编码，给予用户对应的错误提示。</p><p>基于这种场景，我们需要对错误信息进行过滤，在任何非预期的业务错误场景下，只需要抛出这个异常即可。</p><p><strong>业务错误码</strong></p><p>错误码设计如下：</p><ul><li>业务错误码由 10 位纯数字组成。</li><li>业务错误码格式：<code>4030000001</code></li><li>错误码说明</li></ul><table><thead><tr><th>1-3位</th><th>4-5位</th><th>6-8位</th><th>9-10位</th></tr></thead><tbody><tr><td>403</td><td>00</td><td>00</td><td>001</td></tr><tr><td>HTTP状态码</td><td>服务编号，单体服务为00</td><td>模块编码</td><td>业务错误编码，001表示未登录</td></tr></tbody></table><p>以下是个人习惯封装的样子：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">interface</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpError</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">message</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 错误详细描述</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">error_code</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 业务错误编码</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">code</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 业务错误枚举key</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">stirng</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><p>我们还需要实现异常过滤器，负责捕获 <code>HttpException</code> 类实例的异常，并为它们实现自定义响应逻辑。</p><p>异常过滤器类需要实现 <code>ExceptionFilter</code> 接口，<code>@Catch()</code> 装饰器则是告诉 <code>Nest</code> 在发生异常时，需要过滤的类型为 <code>ParamException</code> （如果为空，默认过滤全部异常类型，但是多数情况下，默认需要过滤全部情况），我们可以一次传递多个异常类型。</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Catch</span><span style="color:#BABED8;">(ParamException)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpExceptionFilter</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">implements</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ExceptionFilter</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">catch</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">exception</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">host</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ArgumentsHost</span><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">exception</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">host</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="参数argumentshost" tabindex="-1">参数ArgumentsHost <a class="header-anchor" href="#参数argumentshost" aria-label="Permalink to &quot;参数ArgumentsHost&quot;">​</a></h2><p>可以发现，请求工具（postman）处于一直挂起，这是因为我们在过滤器中未返回<code>RequestObject</code> 内容，！！这会导致客户端一直挂起。</p><p><code>ArgumentsHost</code> 参数则可以获取适当的上下文对象（底层依赖的框架 <code>Express</code> 或其他适配器）， <code>RequestObject</code>可以从中获取，接着我们只要返回内容，即可解除请求挂起的问题。</p><p>控制器抛出错误，由过滤器过滤之后，再返还给客户端：</p><details class="details custom-block"><summary>展开查看异常枚举</summary><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 异常枚举</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ErrorCode</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">#code</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">#msg</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">#errorCode</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">code</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">errorCode</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">msg</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">code</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#msg</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">msg</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#errorCode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">errorCode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">get</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">msg</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#msg</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">get</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">code</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#code</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">get</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">errorCode</span><span style="color:#89DDFF;">()</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">#errorCode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> AUTH_TOKEN_EXPIRED </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">ErrorCode</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">4030000002</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">TOKEN 已经过期或失效</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></details><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// cats.controller.ts</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#82AAFF;">getHello</span><span style="color:#BABED8;">(@</span><span style="color:#82AAFF;">Query</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">) id: string): string </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">id</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">HttpException</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        error_code</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">errorCode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        code</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">code</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        message</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">msg</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">FORBIDDEN</span></span>
<span class="line"><span style="color:#F07178;">    )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello World! </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>完善参数不全的异常过滤器并响应给客户端：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Catch</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpExceptionFilter</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">implements</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ExceptionFilter</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">catch</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">exception</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">HttpException</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">host</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ArgumentsHost</span><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 取得上下文</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ctx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">host</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">switchToHttp</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 响应对象</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">response</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getResponse</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Response</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 请求对象</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">request</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRequest</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Request</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 错误对象</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">reason</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">exception</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getResponse</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">object</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">reason</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">reason</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">...</span><span style="color:#BABED8;">reason</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">request</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">url</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="`+t+`" alt="image-20240121220425386"></p><h2 id="绑定位置" tabindex="-1">绑定位置 <a class="header-anchor" href="#绑定位置" aria-label="Permalink to &quot;绑定位置&quot;">​</a></h2><p>过滤器绑定的位置分为模块、全局。</p><p>模块注册：</p><ul><li>绑定在路由方法之上。</li><li>绑定在控制器上。</li></ul><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 2.绑定整个控制器</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">UseFilters</span><span style="color:#BABED8;">(HttpExceptionFilter)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cats</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CatsController</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">catsService</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CatsService</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 1.绑定在路由方法上</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">UseFilters</span><span style="color:#BABED8;">(HttpExceptionFilter)</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">getHello</span><span style="color:#89DDFF;">(@</span><span style="color:#82AAFF;">Query</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">) </span><span style="color:#BABED8;font-style:italic;">id</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">):</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">id</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">HttpException</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          error_code</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">errorCode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          code</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">code</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          message</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">AUTH_TOKEN_EXPIRED</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">msg</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">HttpStatus</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">FORBIDDEN</span></span>
<span class="line"><span style="color:#F07178;">      )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello World! </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>全局注册：</p><ul><li>在 <code>main</code> 中通过 <code>app.useGlobalFilter</code> 注册全局过滤器。</li><li>通过<a href="#依赖注入">依赖注入</a>的形式注册过滤器。</li></ul><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">useGlobalFilter</span><span style="color:#BABED8;">(HttpExceptionFilter)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="依赖注入" tabindex="-1">依赖注入 <a class="header-anchor" href="#依赖注入" aria-label="Permalink to &quot;依赖注入&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">依赖注入</p><p><code>app.useGlobalFilter</code> 的方式无法使用依赖注入的服务。我们可以在模块中使用依赖注入的方式，这样我们的自定义管道也能使用依赖服务做一些事情。比如在管道中查询数据库，判断是否存在该用户的id。学习更多依赖注入<a href="./provider">点击这里</a>。</p></div><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Module</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@nestjs/common</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">APP_FILTER</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@nestjs/core</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">providers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">provide</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> APP_FILTER</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">useClass</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> HttpExceptionFilter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#BABED8;">    AppService</span></span>
<span class="line"><span style="color:#BABED8;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AppModule</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这样注册后，在 <code>HttpExceptionFilter</code> 方法中就能使用 <code>AppService</code> 这个注入的服务。</p><h2 id="案例一-封装异常错误对象" tabindex="-1">案例一：封装异常错误对象 <a class="header-anchor" href="#案例一-封装异常错误对象" aria-label="Permalink to &quot;案例一：封装异常错误对象&quot;">​</a></h2>`,54)]))}const A=n(c,[["render",r]]);export{E as __pageData,A as default};
